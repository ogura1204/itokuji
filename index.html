<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>町家の日 AR（POP2 GLB化版）</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      /* HTML側のフォント設定 */
      body { margin: 0; overflow: hidden; font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", serif; }

      /* 待機画面 */
      #loading {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #1a1a1a; z-index: 99999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 1.0s ease-out;
      }
      #loading-text { color: #f0f0f0; font-size: 14px; letter-spacing: 3px; margin-top: 20px; text-transform: uppercase; }
      .loader { border: 2px solid rgba(255,255,255,0.1); border-left-color: #ffffff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* フッター */
      #footer-frame {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 10%;
        background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); 
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        display: flex; justify-content: center; align-items: center;
        z-index: 9999; pointer-events: auto; cursor: pointer; transition: background 0.3s; overflow: hidden;
      }
      .footer-text-container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
      .f-text { position: absolute; color: #ffffff; font-family: "Helvetica Neue", Arial, sans-serif; font-size: 12px; letter-spacing: 1px; opacity: 0; width: 100%; text-align: center; transition: opacity 1s ease-in-out; }
      #ft-1 { animation: textCycle1 8s infinite; }
      #ft-2 { animation: textCycle2 8s infinite; }
      @keyframes textCycle1 { 0%, 45% { opacity: 1; transform: translateY(0); } 50%, 100% { opacity: 0; transform: translateY(-5px); } }
      @keyframes textCycle2 { 0%, 45% { opacity: 0; transform: translateY(5px); } 50%, 95% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-5px); } }

      /* 外観エンドロール */
      #outside-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 8888; display: none; overflow: hidden; }
      #credit-roll-content { position: absolute; width: 100%; text-align: center; color: white; text-shadow: 0 2px 10px rgba(0,0,0,1); bottom: -150%; opacity: 0; }
      .animate-roll { animation: rollUp 25s linear forwards; }
      @keyframes rollUp { 0% { bottom: -150%; opacity: 0; } 5% { opacity: 1; } 90% { opacity: 1; } 100% { bottom: 100%; opacity: 0; } }
      .credit-section { font-size: 14px; margin-top: 60px; opacity: 0.7; letter-spacing: 3px; text-transform: uppercase; }
      .credit-name { font-size: 26px; margin-top: 15px; font-weight: bold; letter-spacing: 5px; }
      .credit-logo { margin-top: 80px; width: 180px; height: auto; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.8)); }
    </style>
  </head>
  <body>

    <div id="loading">
      <div class="loader"></div>
      <div id="loading-text">Loading AR Experience</div>
    </div>

    <div id="footer-frame">
      <div class="footer-text-container">
        <div id="ft-1" class="f-text">GPM co., ltd, CLoVER Dept.</div>
        <div id="ft-2" class="f-text">Tap for Link ↗</div>
      </div>
    </div>

    <div id="outside-overlay">
      <div id="credit-roll-content">
        <div class="credit-section">Presented by</div>
        <div class="credit-name">Ogura Sousuke</div>
        <img src="./logo.png" class="credit-logo" alt="GPM CLoVER Logo">
        <div class="credit-section">Chiyoda 731-1 Himeji Hyogo</div>
        <div class="credit-section">AAA Bldg. 2F</div>
        <div class="credit-name">Consumer Dept.</div>
      </div>
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets-2.mind; uiError:yes; uiLoading:no;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <img id="img-pers-1" src="./pers_1.png" />
        <a-asset-item id="model-building" src="./building.glb"></a-asset-item>
        <img id="img-magic-circle" src="./magic_circle.png" />
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-image id="ar-image-1" src="#img-pers-1" position="0 0 0" width="1"></a-image>
        <a-entity position="0 -0.6 0">
            <a-entity position="2 0 0" animation="property: position; from: 2 0 0; to: -2 0 0; dur: 6000; easing: linear; loop: true">
                <a-text value="Miyabe Airi" align="center" color="white" scale="1.5 1.5 1.5"></a-text>
            </a-entity>
        </a-entity>
        <a-entity position="0 -0.8 0">
            <a-entity position="2 0 0" animation="property: position; from: 2 0 0; to: -2 0 0; dur: 6500; easing: linear; loop: true">
                 <a-text value="victorina-vc" align="center" color="white" scale="1.5 1.5 1.5"></a-text>
            </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="target-pop2" mindar-image-target="targetIndex: 1">
        <a-entity gltf-model="#model-building" 
                  scale="0.5 0.5 0.5" 
                  position="0 0 0" 
                  rotation="0 0 0"
                  animation="property: rotation; to: 0 360 0; dur: 20000; loop: true; easing: linear">
        </a-entity>
      </a-entity>

      <a-entity id="target-outside" mindar-image-target="targetIndex: 2">
      </a-entity>

      <a-entity id="target-card" mindar-image-target="targetIndex: 3">
        <a-entity id="magic-circle-container" scale="0 0 0"
                  animation__appear="property: scale; to: 0.6 0.6 0.6; dur: 2000; easing: easeOutCubic; startEvents: appear"
                  animation__disappear="property: scale; to: 0 0 0; dur: 500; easing: easeInQuad; startEvents: disappear">
            <a-image src="#img-magic-circle" width="2" height="2" opacity="0.8"
                     animation="property: rotation; to: 0 0 -360; dur: 60000; loop: true; easing: linear"></a-image>
            <a-entity id="circular-text-ring" animation="property: rotation; to: 0 0 360; dur: 40000; loop: true; easing: linear">
            </a-entity>
        </a-entity>
      </a-entity>

    </a-scene>

    <script>
      const loadingDiv = document.getElementById('loading');
      const footerFrame = document.getElementById('footer-frame');
      
      const targetPop2 = document.getElementById('target-pop2');
      // 動画用の変数は削除しました
      
      const targetOutside = document.getElementById('target-outside');
      const outsideOverlay = document.getElementById('outside-overlay');
      const creditContent = document.getElementById('credit-roll-content');
      
      const targetCard = document.getElementById('target-card');
      const magicCircle = document.getElementById('magic-circle-container');
      const textRing = document.getElementById('circular-text-ring');
      
      const sceneEl = document.querySelector('a-scene');
      let rollTimer = null;

      sceneEl.addEventListener('arReady', () => {
        loadingDiv.style.opacity = 0;
        setTimeout(() => { loadingDiv.style.display = 'none'; }, 1000);
        resizeElement('ar-image-1', 'img-pers-1');
        
        createCircularText();
      });
      setTimeout(() => { if(loadingDiv.style.display !== 'none') loadingDiv.style.display = 'none'; }, 10000);

      function createCircularText() {
        const text = "We look forward to working with you. ";
        const radius = 1.35;
        const totalChars = text.length;
        const angleStep = 360 / totalChars;

        for (let i = 0; i < totalChars; i++) {
          const char = text[i];
          const angle = i * angleStep;
          const pivot = document.createElement('a-entity');
          pivot.setAttribute('rotation', `0 0 ${-angle}`);
          const textEl = document.createElement('a-text');
          textEl.setAttribute('value', char);
          textEl.setAttribute('align', 'center');
          textEl.setAttribute('color', 'white');
          textEl.setAttribute('width', '5');
          textEl.setAttribute('position', `0 ${radius} 0`);
          pivot.appendChild(textEl);
          textRing.appendChild(pivot);
        }
      }

      footerFrame.addEventListener('click', () => { window.open('https://lykke-hygge-2.myshopify.com/', '_blank'); });

      // 外観
      function startRoll() {
        creditContent.classList.remove('animate-roll');
        void creditContent.offsetWidth;
        rollTimer = setTimeout(() => { creditContent.classList.add('animate-roll'); }, 2000);
      }
      creditContent.addEventListener('animationend', () => { startRoll(); });

      targetOutside.addEventListener('targetFound', () => { outsideOverlay.style.display = 'block'; startRoll(); });
      targetOutside.addEventListener('targetLost', () => { outsideOverlay.style.display = 'none'; creditContent.classList.remove('animate-roll'); if (rollTimer) clearTimeout(rollTimer); });

      // 名刺
      targetCard.addEventListener('targetFound', () => { magicCircle.emit('appear'); });
      targetCard.addEventListener('targetLost', () => { magicCircle.emit('disappear'); });

      function resizeElement(arEntityId, sourceId) {
        const arEntity = document.getElementById(arEntityId);
        const source = document.getElementById(sourceId);
        const setSize = () => {
          let w, h;
          if (source.tagName === 'IMG') { w = source.naturalWidth; h = source.naturalHeight; }
          else if (source.tagName === 'VIDEO') { w = source.videoWidth; h = source.videoHeight; }
          if (w && h) { const ratio = h / w; arEntity.setAttribute('height', ratio); }
        };
        if (source.complete || source.readyState >= 1) setSize();
        else { source.onload = setSize; source.onloadedmetadata = setSize; }
      }
    </script>
  </body>
</html>
