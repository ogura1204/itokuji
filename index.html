<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>町家の日 AR Experience</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <script>
      // ▼▼▼ スライドショーコンポーネント（フェード切り替え） ▼▼▼
      AFRAME.registerComponent('auto-slideshow', {
        schema: {
          srcs: { type: 'array' }, 
          interval: { type: 'number', default: 3000 }
        },
        init: function () {
          this.el.setAttribute('src', this.data.srcs[0]);
          this.el.setAttribute('material', 'transparent: true; opacity: 1');
          this.index = 0;
          this.timer = null;
        },
        play: function() {
          if (this.timer) return;
          this.timer = setInterval(() => { this.nextSlide(); }, this.data.interval);
        },
        pause: function() {
          if (this.timer) clearInterval(this.timer);
          this.timer = null;
          this.el.setAttribute('material', 'opacity', 1);
        },
        nextSlide: function () {
          const el = this.el;
          // フェードアウト
          el.setAttribute('animation', { property: 'material.opacity', from: 1, to: 0, dur: 500, easing: 'linear' });

          setTimeout(() => {
            // 画像切り替え
            this.index = (this.index + 1) % this.data.srcs.length;
            el.setAttribute('src', this.data.srcs[this.index]);
            
            // アスペクト比調整
            const img = document.querySelector(this.data.srcs[this.index]);
            if(img && img.naturalWidth) {
                const ratio = img.naturalHeight / img.naturalWidth;
                el.setAttribute('height', ratio);
            }

            // フェードイン
            el.removeAttribute('animation');
            el.setAttribute('animation', { property: 'material.opacity', from: 0, to: 1, dur: 500, easing: 'linear' });
          }, 500);
        }
      });
    </script>

    <style>
      body { margin: 0; overflow: hidden; font-family: "Yu Mincho", serif; background: #000; }

      /* ローディング */
      #loading {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #0a0a0a; z-index: 99999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 0.5s ease-out;
      }
      .loader {
        width: 50px; height: 50px;
        border: 1px solid rgba(197, 160, 89, 0.3);
        border-top: 1px solid #C5A059;
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
      }
      #loading-text { margin-top: 20px; color: #C5A059; font-size: 12px; letter-spacing: 4px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* ガイドメッセージ（認識時に消える） */
      #scan-guide {
        position: fixed; top: 20px; width: 100%; text-align: center;
        color: #fff; font-size: 14px; letter-spacing: 2px;
        background: rgba(0,0,0,0.6); padding: 12px 0;
        pointer-events: none; z-index: 8000;
        transition: opacity 0.5s ease; /* ふわっと消えるアニメーション */
      }

      /* フッター */
      #footer-frame {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
        background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
        border-top: 1px solid rgba(197, 160, 89, 0.3);
        display: flex; justify-content: center; align-items: center;
        z-index: 9999; cursor: pointer;
      }
      .footer-text { color: #fff; font-size: 12px; letter-spacing: 1px; }
    </style>
  </head>
  <body>

    <div id="loading">
      <div class="loader"></div>
      <div id="loading-text">LOADING...</div>
    </div>

    <div id="scan-guide">建物を映してください</div>

    <div id="footer-frame">
      <div class="footer-text">Tap to Open Website</div>
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets4.mind; uiError:yes; uiLoading:no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <video id="vid-asset" src="./fl.mp4" preload="auto" loop="true" crossorigin="anonymous" playsinline webkit-playsinline muted></video>

        <a-asset-item id="model-asset" src="./model2.glb"></a-asset-item>

        <img id="slide1-1" src="./pers_1.png" />
        <img id="slide1-2" src="./pers_1_sub1.png" /> 
        <img id="slide1-3" src="./pers_1_sub2.png" /> 

        <img id="slide2-1" src="./pers_2.png" /> 
        <img id="slide2-2" src="./pers_2_sub1.png" />
        <img id="slide2-3" src="./pers_2_sub2.png" />
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-entity scale="0.5 0.5 0.5">
           <a-plane color="black" opacity="0.8" width="1.1" height="0.7" position="0 0 -0.01"></a-plane>
           <a-video id="ar-video" src="#vid-asset" width="1" height="0.5625"></a-video>
           <a-text value="MOVIE CLIP" align="center" position="0 -0.4 0" width="3" color="#fff" font="roboto"></a-text>
        </a-entity>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 1">
        <a-entity scale="0.5 0.5 0.5">
           <a-entity id="ar-model" gltf-model="#model-asset" 
                     rotation="0 0 0" 
                     animation="property: rotation; to: 0 360 0; dur: 20000; loop: true; easing: linear">
           </a-entity>
           <a-text value="3D MODEL VIEW" align="center" position="0 -0.8 0" width="3" color="#fff" font="roboto"></a-text>
        </a-entity>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 2">
        <a-entity scale="0.5 0.5 0.5">
            <a-plane color="black" opacity="0.6" width="1.1" height="1.0" position="0 0 -0.01"></a-plane>
            
            <a-image id="slideshow-1" 
                     position="0 0 0" width="1" height="0.75"
                     auto-slideshow="srcs: #slide1-1, #slide1-2, #slide1-3; interval: 3000">
            </a-image>
            
            <a-text value="BUILDING A" align="center" position="0 -0.6 0" width="3" color="#fff" font="roboto"></a-text>
        </a-entity>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 3">
        <a-entity scale="0.5 0.5 0.5">
            <a-plane color="black" opacity="0.6" width="1.1" height="1.0" position="0 0 -0.01"></a-plane>

            <a-image id="slideshow-2" 
                     position="0 0 0" width="1" height="0.75"
                     auto-slideshow="srcs: #slide2-1, #slide2-2, #slide2-3; interval: 3000">
            </a-image>
            
            <a-text value="BUILDING B" align="center" position="0 -0.6 0" width="3" color="#fff" font="roboto"></a-text>
        </a-entity>
      </a-entity>

    </a-scene>

    <script>
      const loadingDiv = document.getElementById('loading');
      const scanGuide = document.getElementById('scan-guide');
      const footerFrame = document.getElementById('footer-frame');
      const sceneEl = document.querySelector('a-scene');
      
      // メディア要素
      const videoEl = document.getElementById('vid-asset');
      const slide1 = document.getElementById('slideshow-1');
      const slide2 = document.getElementById('slideshow-2');

      // ロード完了処理
      sceneEl.addEventListener('arReady', () => { hideLoading(); });
      sceneEl.addEventListener('arError', () => { hideLoading(); alert("カメラエラー"); });
      setTimeout(() => { hideLoading(); }, 10000);

      function hideLoading() {
        if(loadingDiv.style.display !== 'none') {
            loadingDiv.style.opacity = 0;
            setTimeout(() => { loadingDiv.style.display = 'none'; }, 500);
        }
      }

      // 認識状態の管理（どれか1つでも認識していたらガイドを消す）
      let activeTargets = 0;

      function updateGuideVisibility() {
          if (activeTargets > 0) {
              scanGuide.style.opacity = 0; // 非表示
          } else {
              scanGuide.style.opacity = 1; // 表示
          }
      }

      // 各ターゲットのイベントリスナー設定
      const targets = [
          { 
            el: document.querySelector('[mindar-image-target="targetIndex: 0"]'), 
            type: 'video', 
            content: videoEl 
          },
          { 
            el: document.querySelector('[mindar-image-target="targetIndex: 1"]'), 
            type: 'model', 
            content: null 
          },
          { 
            el: document.querySelector('[mindar-image-target="targetIndex: 2"]'), 
            type: 'slide', 
            content: slide1 
          },
          { 
            el: document.querySelector('[mindar-image-target="targetIndex: 3"]'), 
            type: 'slide', 
            content: slide2 
          }
      ];

      targets.forEach(t => {
          if(!t.el) return;

          t.el.addEventListener('targetFound', () => {
              activeTargets++;
              updateGuideVisibility();

              // メディアごとの再生処理
              if (t.type === 'video') t.content.play();
              if (t.type === 'slide' && t.content.components['auto-slideshow']) {
                  t.content.components['auto-slideshow'].play();
              }
          });

          t.el.addEventListener('targetLost', () => {
              activeTargets--;
              if(activeTargets < 0) activeTargets = 0;
              updateGuideVisibility();

              // メディアごとの停止処理
              if (t.type === 'video') t.content.pause();
              if (t.type === 'slide' && t.content.components['auto-slideshow']) {
                  t.content.components['auto-slideshow'].pause();
              }
          });
      });

      footerFrame.addEventListener('click', () => {
        window.open('https://lykke-hygge-2.myshopify.com/', '_blank'); 
      });
    </script>
  </body>
</html>
