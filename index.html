<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>町家の日 GPS AR (診断モード)</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <script>
      // 1. ジェスチャー操作 (回転・拡大縮小)
      AFRAME.registerComponent("gesture-handler", {
        schema: { enabled: { default: true }, rotationFactor: { default: 5 }, minScale: { default: 0.1 }, maxScale: { default: 20 } },
        init: function() {
          this.handleScale = this.handleScale.bind(this);
          this.handleRotation = this.handleRotation.bind(this);
          this.isVisible = true; 
          this.initialScale = this.el.object3D.scale.clone();
          this.scaleFactor = 1;
          this.el.sceneEl.addEventListener("touchmove", (event) => {
              if (event.touches.length === 1) this.handleRotation(event);
              if (event.touches.length === 2) this.handleScale(event);
          });
        },
        handleRotation: function(event) {
          // 簡易的な1本指回転
          this.el.object3D.rotation.y += event.movementX * 0.005;
        },
        handleScale: function(event) {
          // 簡易的な2本指スケール（実装省略、今回は表示優先）
        }
      });

      // 2. 距離計算とデバッグ表示
      AFRAME.registerComponent('gps-debug', {
        init: function() {
          this.debugInfo = document.getElementById('debug-info');
        },
        tick: function() {
          const camera = document.querySelector('[gps-camera]');
          const target = document.querySelector('[gps-entity-place]');
          
          if (camera && target) {
            // AR.jsの内部計算距離を取得
            const distance = camera.components['gps-camera'].distanceTo(target.components['gps-entity-place'].coords);
            if(this.debugInfo) {
                this.debugInfo.innerText = `Distance: ${Math.round(distance)} m`;
            }
          }
        }
      });
      
      // 3. ビルボード（常に自分の方を向く）
      AFRAME.registerComponent('look-at-camera', {
        tick: function () {
          var camera = this.el.sceneEl.camera;
          if (!camera) return;
          this.el.object3D.lookAt(camera.position);
        }
      });
    </script>

    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      
      /* デバッグ情報パネル */
      #debug-panel {
        position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: lime; padding: 10px; z-index: 9999; border-radius: 5px; font-size: 14px; pointer-events: none;
      }
      
      /* 強制配置ボタン */
      #force-btn {
        position: fixed; top: 10px; right: 10px; background: red; color: white; padding: 10px 20px; z-index: 9999; border: none; border-radius: 5px; font-weight: bold;
      }

      #footer-frame { position: fixed; bottom: 0; left: 0; width: 100%; height: 10%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; }
      .f-text { color: white; font-size: 12px; pointer-events: auto; cursor: pointer; padding: 10px; }
    </style>
  </head>
  
  <body>
    <div id="debug-panel">
        <div>GPS Status: <span id="gps-status">Waiting...</span></div>
        <div id="debug-info">Distance: --- m</div>
    </div>

    <button id="force-btn" onclick="forcePlaceModel()">TEST: 目の前に置く</button>

    <div id="footer-frame"><div class="f-text" onclick="window.open('https://lykke-hygge-2.myshopify.com/', '_blank');">Tap to Open Shop</div></div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
      renderer="colorManagement: true; physicallyCorrectLights: true; toneMapping: ACESFilmic; exposure: 1.0;">

      <a-assets>
        <a-asset-item id="model-glb" src="./model2.glb"></a-asset-item>
      </a-assets>

      <a-camera gps-camera rotation-reader cursor="fuse: false; rayOrigin: mouse;" raycaster="objects: .clickable"></a-camera>

      <a-light type="hemisphere" skyColor="#ffffff" groundColor="#444444" intensity="1.2"></a-light>
      <a-light type="directional" color="#ffffff" intensity="2.0" position="2 4 4"></a-light>

      <a-entity id="gps-target" gps-entity-place="latitude: 34.82749460261197; longitude: 134.68015716788724;" gps-debug>

        <a-entity id="ar-content" position="0 0 0" look-at-camera>

            <a-entity id="msg-panel-container" position="0 9.5 0" scale="2 2 2">
                <a-entity animation="property: position; to: 0 0.2 0; dir: alternate; dur: 2000; loop: true; easing: easeInOutSine">
                    <a-plane color="black" opacity="0.7" width="1.8" height="0.6" position="0 0 0"></a-plane>
                    <a-plane color="#ffffff" width="1.6" height="0.02" position="0 -0.2 0.01"></a-plane>
                    <a-text value="2026.8" align="center" color="#ffffff" width="5" position="0 0.12 0.01"></a-text>
                    <a-text value="GRAND OPEN" align="center" color="#FFD700" width="4" position="0 -0.05 0.01"></a-text>
                </a-entity>
            </a-entity>

            <a-entity id="my-model"
                      gltf-model="#model-glb" 
                      position="0 0 0" 
                      scale="8 8 8"
                      class="clickable"
                      gesture-handler>
            </a-entity>

        </a-entity>
      </a-entity>

    </a-scene>

    <script>
      // GPSステータス更新
      window.addEventListener('gps-camera-update-position', function(e) {
        document.getElementById('gps-status').innerText = "Found (Tracking)";
        document.getElementById('gps-status').style.color = "lime";
      });

      // 【診断機能】強制的にモデルを目の前に移動させる関数
      function forcePlaceModel() {
        const target = document.getElementById('gps-target');
        const camera = document.querySelector('[gps-camera]');
        
        // GPS属性を削除（GPS制御から外す）
        target.removeAttribute('gps-entity-place');
        
        // カメラのローカル座標系に追加しなおす（カメラの子要素にする）
        // これで「スマホの画面の奥 10m」に固定されます
        camera.appendChild(target);
        
        // 位置とスケールを調整（目の前で見やすいように）
        target.setAttribute('position', '0 0 -10'); // 10m手前
        target.setAttribute('scale', '0.5 0.5 0.5'); // 少し小さくする（近すぎるため）
        
        alert("テストモード: GPSを無視してカメラの前に配置しました。\nこれでモデルが見えない場合は、データ読み込みエラーの可能性があります。");
      }
    </script>
  </body>
</html>
