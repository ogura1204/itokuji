<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç”ºå®¶ã®æ—¥ AR (å¼·åˆ¶é…ç½®ç‰ˆ)</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      
      /* è¨ºæ–­ç”¨ãƒ‘ãƒãƒ« */
      #info-panel {
        position: fixed; top: 0; left: 0; width: 100%;
        background: rgba(0,0,0,0.8); color: lime;
        padding: 5px; font-size: 11px; z-index: 9999;
        pointer-events: none;
        white-space: pre-wrap;
      }

      /* å¼·åˆ¶é…ç½®ãƒœã‚¿ãƒ³ï¼ˆèµ¤ï¼‰ */
      #spawn-btn {
        position: fixed; top: 60px; right: 10px;
        background: #dc3545; color: white;
        padding: 15px 20px; border: none; border-radius: 30px;
        font-weight: bold; font-size: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        z-index: 9999;
      }
      
      #footer-frame { position: fixed; bottom: 0; left: 0; width: 100%; height: 10%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; }
      .f-text { color: white; font-size: 12px; pointer-events: auto; cursor: pointer; padding: 10px; }
    </style>
  </head>
  
  <body>
    <div id="info-panel">
GPS: Initializing...
Target: 34.827494, 134.680157
Model Status: Loading...
    </div>

    <button id="spawn-btn" onclick="forceSpawn()">ğŸ“ ã“ã“ã«ãƒ¢ãƒ‡ãƒ«ã‚’ç½®ã</button>

    <div id="footer-frame"><div class="f-text" onclick="window.open('https://lykke-hygge-2.myshopify.com/', '_blank');">Tap to Open Shop</div></div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
      renderer="colorManagement: true; physicallyCorrectLights: true; toneMapping: ACESFilmic; exposure: 1.0;">

      <a-assets>
        <a-asset-item id="model-glb" src="./model2.glb"></a-asset-item>
      </a-assets>

      <a-camera gps-camera="gpsMinDistance: 0;" rotation-reader near="0.1" far="10000">
      </a-camera>

      <a-light type="ambient" color="#ffffff" intensity="2.0"></a-light>
      <a-light type="directional" color="#ffffff" intensity="2.0" position="0 10 0"></a-light>

      <a-entity id="move-container" position="0 -1000 0" visible="false">
          
          <a-box color="cyan" position="0 2 0" scale="0.5 4 0.5" material="opacity: 0.8"></a-box>
          <a-text value="HERE!" color="white" align="center" position="0 4.5 0" scale="3 3 3" look-at="[gps-camera]"></a-text>

          <a-entity position="0 5 0" scale="2 2 2" look-at="[gps-camera]">
              <a-plane color="black" opacity="0.6" width="2" height="0.8"></a-plane>
              <a-text value="2026.8 OPEN" align="center" width="6" position="0 0 0.1"></a-text>
          </a-entity>

          <a-entity id="my-model"
                    gltf-model="#model-glb" 
                    position="0 0 0" 
                    scale="5 5 5"
                    animation="property: rotation; to: 0 360 0; dur: 20000; loop: true; easing: linear">
          </a-entity>
      </a-entity>

    </a-scene>

    <script>
      // ãƒ­ã‚°å‡ºåŠ›ç”¨
      const infoPanel = document.getElementById('info-panel');
      function log(text) {
          const current = infoPanel.innerText;
          // 10è¡Œä»¥ä¸Šãªã‚‰ã‚«ãƒƒãƒˆ
          const lines = current.split('\n');
          if (lines.length > 8) lines.shift();
          infoPanel.innerText = lines.join('\n') + '\n' + text;
      }

      // 1. ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ç¢ºèª
      document.querySelector('a-scene').addEventListener('loaded', () => {
          log("Scene Loaded.");
      });
      document.querySelector('#model-glb').addEventListener('loaded', () => {
          log("Model: Loaded OK âœ…");
      });
      document.querySelector('#model-glb').addEventListener('error', (e) => {
          log("Model: Load ERROR âŒ");
      });

      // 2. GPSç”Ÿãƒ‡ãƒ¼ã‚¿ã®ç›£è¦–
      window.addEventListener('gps-camera-update-position', function(e) {
          // è‡ªåˆ†ã®ä½ç½®
          const myLat = e.detail.position.latitude.toFixed(6);
          const myLon = e.detail.position.longitude.toFixed(6);
          
          // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä½ç½® (34.827494, 134.680157)
          const targetLat = 34.827494;
          const targetLon = 134.680157;

          // ç°¡æ˜“è·é›¢è¨ˆç®— (ä¸‰å¹³æ–¹ã®å®šç†çš„ãªæ¦‚ç®—)
          // ç·¯åº¦1åº¦â‰’111km, çµŒåº¦1åº¦â‰’91km(æ—¥æœ¬ä»˜è¿‘)
          const dy = (targetLat - myLat) * 111000;
          const dx = (targetLon - myLon) * 91000;
          const dist = Math.sqrt(dx*dx + dy*dy);

          // ç”»é¢æ›´æ–°
          // å¸¸ã«æœ€æ–°ã®GPSæƒ…å ±ã‚’1è¡Œç›®ã«æ›¸ãæ›ãˆã‚‹
          const statusText = `GPS: Active (${myLat}, ${myLon})\nDist: Approx ${Math.round(dist)}m`;
          
          // ãƒ‘ãƒãƒ«ã®å…ˆé ­ã‚’æ›¸ãæ›ãˆï¼ˆæ‰‹æŠœãå®Ÿè£…ã§ã™ãŒå‹•ä½œå„ªå…ˆï¼‰
          const lines = infoPanel.innerText.split('\n');
          lines[0] = statusText;
          infoPanel.innerText = lines.join('\n');
      });

      // 3. ã€æœ€é‡è¦ã€‘å¼·åˆ¶é…ç½®æ©Ÿèƒ½
      function forceSpawn() {
          const camera = document.querySelector('[gps-camera]');
          const container = document.getElementById('move-container');
          const btn = document.getElementById('spawn-btn');
          
          // ã‚«ãƒ¡ãƒ©ã®ç¾åœ¨ä½ç½®ã¨å‘ãã‚’å–å¾—
          const camPos = camera.object3D.position;
          
          // ã‚«ãƒ¡ãƒ©ã®å‘ã„ã¦ã„ã‚‹æ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«ã‚’å–å¾—
          const direction = new THREE.Vector3();
          camera.object3D.getWorldDirection(direction);
          
          // ã€Œç›®ã®å‰ 5ãƒ¡ãƒ¼ãƒˆãƒ«ã€ã‚’è¨ˆç®—
          // ã‚«ãƒ¡ãƒ©ä½ç½® + (æ–¹å‘ * 5m)
          // yæˆåˆ†ï¼ˆé«˜ã•ï¼‰ã¯ç„¡è¦–ã—ã¦ã€è‡ªåˆ†ã®è¶³å…ƒã¨åŒã˜é«˜ã•ã«ã™ã‚‹
          const spawnX = camPos.x + (direction.x * 5);
          const spawnZ = camPos.z + (direction.z * 5);
          const spawnY = camPos.y - 1.5; // ã‚«ãƒ¡ãƒ©ã®é«˜ã•(ç´„1.5m)åˆ†ä¸‹ã’ã‚‹ï¼åœ°é¢
          
          // ã‚³ãƒ³ãƒ†ãƒŠã‚’ãã“ã«ç§»å‹•
          container.object3D.position.set(spawnX, spawnY, spawnZ);
          container.setAttribute('visible', 'true');
          
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢ï¼ˆé‡ã„å ´åˆã®ãŸã‚ï¼‰
          // container.removeAttribute('animation');

          log(`Spawned at: ${Math.round(spawnX)}, ${Math.round(spawnZ)}`);
          btn.innerText = "ğŸ“ å†é…ç½®ã™ã‚‹";
          btn.style.background = "#007BFF";
      }
    </script>
  </body>
</html>
