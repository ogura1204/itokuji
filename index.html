<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>町家の日 GPS AR</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <script>
      // 1. ジェスチャー検出
      AFRAME.registerComponent("gesture-detector", {
        schema: { element: { default: "" } },
        init: function() {
          this.targetElement = this.data.element && document.querySelector(this.data.element);
          if (!this.targetElement) { this.targetElement = this.el; }
          this.internalState = { previousState: null };
          this.emitGestureEvent = this.emitGestureEvent.bind(this);
          this.targetElement.addEventListener("touchstart", this.emitGestureEvent);
          this.targetElement.addEventListener("touchend", this.emitGestureEvent);
          this.targetElement.addEventListener("touchmove", this.emitGestureEvent);
        },
        remove: function() {
          this.targetElement.removeEventListener("touchstart", this.emitGestureEvent);
          this.targetElement.removeEventListener("touchend", this.emitGestureEvent);
          this.targetElement.removeEventListener("touchmove", this.emitGestureEvent);
        },
        emitGestureEvent: function(event) {
          const currentState = this.getTouchState(event);
          const previousState = this.internalState.previousState;
          const gestureContinues = previousState && currentState && currentState.touchCount == previousState.touchCount;
          const gestureEnded = previousState && !gestureContinues;
          const gestureStarted = currentState && !gestureContinues;
          if (gestureEnded) { this.el.emit("gesture-end"); }
          if (gestureStarted) { this.el.emit("gesture-start"); }
          if (gestureContinues) {
            const eventDetail = {
              positionChange: { x: currentState.position.x - previousState.position.x, y: currentState.position.y - previousState.position.y },
              spreadChange: currentState.spread - previousState.spread,
              startPosition: previousState.position,
              position: currentState.position,
              spread: currentState.spread,
            };
            if (currentState.touchCount == 1) { this.el.emit("onefingermove", eventDetail); }
            if (currentState.touchCount == 2) { this.el.emit("twofingermove", eventDetail); }
          }
          this.internalState.previousState = currentState;
        },
        getTouchState: function(event) {
          if (event.touches.length === 0) { return null; }
          if (event.touches.length === 1) {
            return { touchCount: 1, position: { x: event.touches[0].pageX, y: event.touches[0].pageY }, spread: 0 };
          }
          const spread = Math.hypot(event.touches[0].pageX - event.touches[1].pageX, event.touches[0].pageY - event.touches[1].pageY);
          return { touchCount: 2, position: { x: (event.touches[0].pageX + event.touches[1].pageX) / 2, y: (event.touches[0].pageY + event.touches[1].pageY) / 2 }, spread: spread };
        }
      });

      // 2. ジェスチャー操作
      AFRAME.registerComponent("gesture-handler", {
        schema: {
          enabled: { default: true },
          rotationFactor: { default: 5 },
          minScale: { default: 0.1 },
          maxScale: { default: 20 },
        },
        init: function() {
          this.handleScale = this.handleScale.bind(this);
          this.handleRotation = this.handleRotation.bind(this);
          this.isVisible = true; 
          this.initialScale = this.el.object3D.scale.clone();
          this.scaleFactor = 1;
          this.el.sceneEl.addEventListener("gesture-detector", (evt) => {});
          this.el.sceneEl.addEventListener("twofingermove", this.handleScale);
          this.el.sceneEl.addEventListener("onefingermove", this.handleRotation);
        },
        remove: function() {
          this.el.sceneEl.removeEventListener("twofingermove", this.handleScale);
          this.el.sceneEl.removeEventListener("onefingermove", this.handleRotation);
        },
        handleRotation: function(event) {
          if (this.isVisible) {
            this.el.object3D.rotation.y += event.detail.positionChange.x * this.data.rotationFactor * 0.001;
          }
        },
        handleScale: function(event) {
          if (this.isVisible) {
            this.scaleFactor *= 1 + event.detail.spreadChange / event.detail.spread;
            this.scaleFactor = Math.min(Math.max(this.scaleFactor, this.data.minScale), this.data.maxScale);
            this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
            this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
            this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
          }
        }
      });
      
      // ビルボード（常に自分の方を向く）
      AFRAME.registerComponent('look-at', {
        schema: { type: 'selector' },
        init: function () {},
        tick: function () {
          this.el.object3D.lookAt(this.data.object3D.position);
        }
      });
    </script>

    <style>
      body { margin: 0; overflow: hidden; font-family: "Yu Mincho", serif; }
      #footer-frame { position: fixed; bottom: 0; left: 0; width: 100%; height: 10%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; pointer-events: none; }
      .f-text { color: white; font-size: 12px; pointer-events: auto; cursor: pointer; padding: 10px; }
      
      /* GPS案内表示 */
      #gps-status {
          position: fixed; top: 10px; left: 0; width: 100%; text-align: center; color: white; background: rgba(0,0,0,0.5); padding: 5px; z-index: 9999;
          transition: opacity 0.5s ease;
      }
    </style>
  </head>
  
  <body>
    <div id="gps-status">GPS Searching...</div>
    <div id="footer-frame"><div class="f-text" onclick="window.open('https://lykke-hygge-2.myshopify.com/', '_blank');">Tap to Open Shop</div></div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
      renderer="colorManagement: true; physicallyCorrectLights: true; toneMapping: ACESFilmic; exposure: 1.0;"
      gesture-detector>

      <a-assets>
        <a-asset-item id="model-glb" src="./model2.glb"></a-asset-item>
      </a-assets>

      <a-camera gps-camera="gpsMinDistance: 5;" rotation-reader look-controls-enabled='false' arjs-look-controls='smoothingFactor: 0.1' 
                cursor="fuse: false; rayOrigin: mouse;" raycaster="objects: .clickable">
      </a-camera>

      <a-light type="hemisphere" skyColor="#ffffff" groundColor="#444444" intensity="1.2"></a-light>
      <a-light type="directional" color="#ffffff" intensity="2.0" position="2 4 4"></a-light>
      <a-light type="directional" color="#ffeedd" intensity="2.0" position="-2 3 -5"></a-light>
      <a-light type="directional" color="#dbeeff" intensity="0.8" position="-4 2 2"></a-light>

      <a-entity gps-entity-place="latitude: 34.82749460261197; longitude: 134.68015716788724;">

        <a-entity id="ar-content" position="0 0 0" look-at="[gps-camera]">

            <a-entity id="msg-panel-container" position="0 9.5 0" scale="2 2 2">
                <a-entity animation="property: position; to: 0 0.2 0; dir: alternate; dur: 2000; loop: true; easing: easeInOutSine">
                    <a-plane color="black" opacity="0.7" width="1.8" height="0.6" position="0 0 0"></a-plane>
                    <a-plane color="#ffffff" width="1.6" height="0.02" position="0 -0.2 0.01"></a-plane>
                    <a-text value="2026.8" align="center" color="#ffffff" width="5" position="0 0.12 0.01" font="roboto" shader="msdf"></a-text>
                    <a-text value="GRAND OPEN" align="center" color="#FFD700" width="4" position="0 -0.05 0.01" font="roboto" shader="msdf" letter-spacing="2"></a-text>
                </a-entity>
            </a-entity>

            <a-entity id="my-model"
                      gltf-model="#model-glb" 
                      position="0 0 0" 
                      rotation="0 0 0" 
                      scale="8 8 8"
                      class="clickable"
                      gesture-handler="minScale: 1; maxScale: 50; rotationFactor: 5">
            </a-entity>

        </a-entity>
      </a-entity>

    </a-scene>

    <script>
      // 対策：5秒経ってもGPSイベントが来なくても、強制的に「Searching...」を消す
      // これにより、GPS感度が悪くても画面操作が可能になります。
      setTimeout(() => {
        const gpsStatus = document.getElementById('gps-status');
        if(gpsStatus) {
            gpsStatus.style.opacity = '0';
            setTimeout(() => gpsStatus.style.display = 'none', 500);
        }
      }, 5000);

      // 通常のGPSイベント検知
      window.addEventListener('gps-camera-update-position', function(e) {
        const gpsStatus = document.getElementById('gps-status');
        if(gpsStatus) {
            gpsStatus.textContent = "GPS Found";
            setTimeout(() => {
                gpsStatus.style.opacity = '0';
                setTimeout(() => gpsStatus.style.display = 'none', 500);
            }, 2000);
        }
      });
      
      // モデル操作の有効化
      const modelEntity = document.getElementById('my-model');
      if(modelEntity) {
        setTimeout(() => {
             if(modelEntity.components['gesture-handler']) {
                 modelEntity.components['gesture-handler'].isVisible = true;
             }
        }, 1000);
      }
    </script>
  </body>
</html>
