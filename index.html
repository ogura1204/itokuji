<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç”ºå®¶ã®æ—¥ AR (å®‰å®šé…ç½®ç‰ˆ)</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      
      /* UIãƒ‘ãƒãƒ« */
      #ui-layer {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 25%;
        background: rgba(0,0,0,0.6);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 9999;
      }

      /* ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
      #place-btn {
        background: #dc3545; color: white;
        padding: 12px 40px; border: none; border-radius: 30px;
        font-weight: bold; font-size: 18px; margin-bottom: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      }
      
      /* èª¿æ•´ãƒœã‚¿ãƒ³ */
      .ctrl-row { display: flex; gap: 15px; margin-bottom: 5px; }
      .ctrl-btn {
        background: white; border: 1px solid #ccc;
        padding: 8px 15px; border-radius: 5px; font-weight: bold;
      }
      .ctrl-btn:active { background: #ddd; }

      /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
      #status-msg {
        position: fixed; top: 10px; left: 0; width: 100%;
        text-align: center; color: yellow; font-weight: bold;
        text-shadow: 1px 1px 2px black; pointer-events: none; z-index: 9998;
      }
    </style>

    <script>
      // ã€é‡è¦ã€‘ã‚«ãƒ¡ãƒ©è¿½å¾“ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
      // ãƒ¢ãƒ‡ãƒ«ã‚’å†èª­ã¿è¾¼ã¿ã•ã›ãšã€æ¯ãƒ•ãƒ¬ãƒ¼ãƒ åº§æ¨™ã ã‘ã‚’æ›´æ–°ã—ã¦ã€ŒæŒã£ã¦ã„ã‚‹ã€ã‚ˆã†ã«è¦‹ã›ã‚‹
      AFRAME.registerComponent('camera-follower', {
        schema: {
          active: { default: true }, // trueãªã‚‰è¿½å¾“ã€falseãªã‚‰å›ºå®š
          distance: { default: 3.0 } // ã‚«ãƒ¡ãƒ©ã‹ã‚‰ã®è·é›¢
        },
        tick: function () {
          if (!this.data.active) return; // å›ºå®šãƒ¢ãƒ¼ãƒ‰ãªã‚‰ä½•ã‚‚ã—ãªã„

          const camera = this.el.sceneEl.camera;
          if (!camera) return;

          // ã‚«ãƒ¡ãƒ©ã®æ–¹å‘ã¨ä½ç½®ã‚’å–å¾—
          const direction = new THREE.Vector3();
          camera.getWorldDirection(direction); // å‘ã„ã¦ã„ã‚‹æ–¹å‘
          direction.y = 0; // åœ°é¢ã«æ°´å¹³ã«ã™ã‚‹ï¼ˆè¦‹ä¸Šã’ã¦ã‚‚ãƒ¢ãƒ‡ãƒ«ãŒç©ºã«é£›ã°ãªã„ã‚ˆã†ã«ï¼‰
          direction.normalize();

          const position = new THREE.Vector3();
          camera.getWorldPosition(position); // ã‚«ãƒ¡ãƒ©ã®ç¾åœ¨åœ°

          // ã€Œç›®ã®å‰â—‹ãƒ¡ãƒ¼ãƒˆãƒ«ã€ã®ä½ç½®ã‚’è¨ˆç®—
          // ã‚«ãƒ¡ãƒ©ä½ç½® + (æ–¹å‘ Ã— è·é›¢)
          const targetPos = position.clone().add(direction.multiplyScalar(this.data.distance));
          
          // é«˜ã•ã¯åœ°é¢(-1.5mãã‚‰ã„)ã«å›ºå®š
          // â€»AR.jsã®Webcamãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚«ãƒ¡ãƒ©é«˜ã•ãŒ0ã€œ1.6mä»˜è¿‘ã«ãªã‚‹ãŸã‚ã€é©å®œèª¿æ•´
          targetPos.y = position.y - 1.0; 

          // ãƒ¢ãƒ‡ãƒ«ã«é©ç”¨
          this.el.object3D.position.copy(targetPos);

          // ãƒ¢ãƒ‡ãƒ«ã®å‘ãã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã‚‹ï¼ˆYè»¸å›è»¢ã®ã¿ï¼‰
          const lookAtPos = position.clone();
          lookAtPos.y = targetPos.y; // é«˜ã•ã‚’åˆã‚ã›ã‚‹ã“ã¨ã§å‚¾ãé˜²æ­¢
          this.el.object3D.lookAt(lookAtPos);
          // lookAtã ã¨èƒŒé¢ãŒå‘ãå ´åˆãŒã‚ã‚‹ã®ã§180åº¦åè»¢
          this.el.object3D.rotateY(Math.PI); 
        }
      });
    </script>
  </head>
  
  <body>
    <div id="status-msg">ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...</div>

    <div id="ui-layer">
        <div class="ctrl-row">
            <button class="ctrl-btn" onclick="adjustScale(0.8)">ç¸®å°</button>
            <button class="ctrl-btn" onclick="adjustScale(1.25)">æ‹¡å¤§</button>
            <button class="ctrl-btn" onclick="adjustDist(0.5)">é ãã¸</button>
            <button class="ctrl-btn" onclick="adjustDist(-0.5)">è¿‘ãã¸</button>
        </div>
        <button id="place-btn" onclick="toggleMode()">ğŸ“ ã“ã“ã«å›ºå®šã™ã‚‹</button>
        <div style="color:white; font-size:10px; margin-top:5px;" onclick="window.open('https://lykke-hygge-2.myshopify.com/', '_blank');">Shop Link</div>
    </div>

    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      vr-mode-ui="enabled: false"
      renderer="colorManagement: true; physicallyCorrectLights: true; toneMapping: ACESFilmic; exposure: 1.0;">

      <a-assets>
        <a-asset-item id="model-glb" src="./model2.glb"></a-asset-item>
      </a-assets>

      <a-camera id="camera" position="0 0 0" near="0.01" far="10000"></a-camera>

      <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
      <a-light type="directional" color="#ffffff" intensity="1.5" position="0 10 0"></a-light>

      <a-entity id="model-wrapper" camera-follower="active: true; distance: 3">
          
          <a-box color="red" position="0 2 0" scale="0.3 0.3 0.3" 
                 animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"></a-box>
          
          <a-entity position="0 3.5 0" scale="2 2 2">
              <a-plane color="black" opacity="0.6" width="2" height="0.8"></a-plane>
              <a-text value="2026.8 OPEN" align="center" width="6" position="0 0.1 0.1"></a-text>
              <a-text value="GRAND OPEN" align="center" color="gold" width="4" position="0 -0.1 0.1"></a-text>
          </a-entity>

          <a-entity id="my-model" 
                    gltf-model="#model-glb"
                    scale="0.5 0.5 0.5">
          </a-entity>
      </a-entity>

    </a-scene>

    <script>
      const wrapper = document.getElementById('model-wrapper');
      const model = document.getElementById('my-model');
      const btn = document.getElementById('place-btn');
      const statusMsg = document.getElementById('status-msg');

      let isFollowing = true;
      let currentDist = 3.0;

      // 1. å›ºå®šãƒ»è§£é™¤åˆ‡ã‚Šæ›¿ãˆ
      function toggleMode() {
        isFollowing = !isFollowing;
        
        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® active ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›¸ãæ›ãˆã‚‹
        wrapper.setAttribute('camera-follower', 'active', isFollowing);

        if (isFollowing) {
            btn.innerText = "ğŸ“ ã“ã“ã«å›ºå®šã™ã‚‹";
            btn.style.background = "#dc3545"; // èµ¤
            statusMsg.innerText = "ç§»å‹•ä¸­ï¼šã‚¹ãƒãƒ›ã«ã¤ã„ã¦ãã¾ã™";
        } else {
            btn.innerText = "ğŸ”„ æŒã¡é‹ã¶ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰";
            btn.style.background = "#007BFF"; // é’
            statusMsg.innerText = "å›ºå®šã—ã¾ã—ãŸï¼é›¢ã‚Œã¦è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™";
        }
      }

      // 2. ã‚µã‚¤ã‚ºèª¿æ•´
      function adjustScale(ratio) {
        const current = model.object3D.scale;
        model.object3D.scale.set(current.x * ratio, current.y * ratio, current.z * ratio);
        statusMsg.innerText = `ã‚µã‚¤ã‚ºèª¿æ•´: ${(current.x).toFixed(2)}`;
      }

      // 3. è·é›¢èª¿æ•´
      function adjustDist(delta) {
        if (!isFollowing) {
             statusMsg.innerText = "å›ºå®šä¸­ã¯ç§»å‹•ã§ãã¾ã›ã‚“ã€‚ã€ŒæŒã¡é‹ã¶ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„";
             return;
        }
        currentDist += delta;
        if(currentDist < 0.5) currentDist = 0.5; // è¿‘ã™ãé˜²æ­¢
        
        wrapper.setAttribute('camera-follower', 'distance', currentDist);
        statusMsg.innerText = `è·é›¢èª¿æ•´: ${currentDist.toFixed(1)}m å…ˆ`;
      }

      // 4. ãƒ­ãƒ¼ãƒ‰ç¢ºèª
      document.querySelector('#model-glb').addEventListener('loaded', () => {
          statusMsg.innerText = "æº–å‚™å®Œäº†ï¼";
      });
      document.querySelector('#model-glb').addEventListener('error', () => {
          statusMsg.innerText = "ã‚¨ãƒ©ãƒ¼ï¼šãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
          statusMsg.style.color = "red";
      });
    </script>
  </body>
</html>
