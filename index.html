<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>町家の日 AR Experience</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <script>
      // ▼▼▼ 1. ジェスチャー検出 ▼▼▼
      AFRAME.registerComponent("gesture-detector", {
        schema: { element: { default: "" } },
        init: function() {
          this.targetElement = this.data.element && document.querySelector(this.data.element);
          if (!this.targetElement) { this.targetElement = this.el; }
          this.internalState = { previousState: null };
          this.emitGestureEvent = this.emitGestureEvent.bind(this);
          this.targetElement.addEventListener("touchstart", this.emitGestureEvent);
          this.targetElement.addEventListener("touchend", this.emitGestureEvent);
          this.targetElement.addEventListener("touchmove", this.emitGestureEvent);
        },
        remove: function() {
          this.targetElement.removeEventListener("touchstart", this.emitGestureEvent);
          this.targetElement.removeEventListener("touchend", this.emitGestureEvent);
          this.targetElement.removeEventListener("touchmove", this.emitGestureEvent);
        },
        emitGestureEvent: function(event) {
          const currentState = this.getTouchState(event);
          const previousState = this.internalState.previousState;
          const gestureContinues = previousState && currentState && currentState.touchCount == previousState.touchCount;
          
          if (gestureContinues) {
            const eventDetail = {
              positionChange: { x: currentState.position.x - previousState.position.x, y: currentState.position.y - previousState.position.y },
              spreadChange: currentState.spread - previousState.spread,
            };
            if (currentState.touchCount == 1) { this.el.emit("onefingermove", eventDetail); }
            if (currentState.touchCount == 2) { this.el.emit("twofingermove", eventDetail); }
          }
          this.internalState.previousState = currentState;
        },
        getTouchState: function(event) {
          if (event.touches.length === 0) return null;
          if (event.touches.length === 1) {
            return { touchCount: 1, position: { x: event.touches[0].pageX, y: event.touches[0].pageY }, spread: 0 };
          }
          const spread = Math.hypot(event.touches[0].pageX - event.touches[1].pageX, event.touches[0].pageY - event.touches[1].pageY);
          return { touchCount: 2, position: { x: 0, y: 0 }, spread: spread };
        }
      });

      // ▼▼▼ 2. ジェスチャー操作 ▼▼▼
      AFRAME.registerComponent("gesture-handler", {
        schema: {
          enabled: { default: true },
          rotationFactor: { default: 5 },
          minScale: { default: 0.1 },
          maxScale: { default: 8 },
        },
        init: function() {
          this.handleScale = this.handleScale.bind(this);
          this.handleRotation = this.handleRotation.bind(this);
          this.isVisible = false;
          this.initialScale = this.el.object3D.scale.clone();
          this.scaleFactor = 1;
          
          this.el.sceneEl.addEventListener("markerFound", (e) => { this.isVisible = true; });
          this.el.sceneEl.addEventListener("markerLost", (e) => { this.isVisible = false; });
          
          this.el.sceneEl.addEventListener("twofingermove", this.handleScale);
          this.el.sceneEl.addEventListener("onefingermove", this.handleRotation);
        },
        remove: function() {
          this.el.sceneEl.removeEventListener("twofingermove", this.handleScale);
          this.el.sceneEl.removeEventListener("onefingermove", this.handleRotation);
        },
        handleRotation: function(event) {
          if (this.isVisible) {
            this.el.object3D.rotation.y += event.detail.positionChange.x * this.data.rotationFactor * 0.001;
          }
        },
        handleScale: function(event) {
          if (this.isVisible) {
            this.scaleFactor *= 1 + event.detail.spreadChange / event.detail.spread;
            this.scaleFactor = Math.min(Math.max(this.scaleFactor, this.data.minScale), this.data.maxScale);
            this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
            this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
            this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
          }
        }
      });

      // ▼▼▼ 3. スライドショー ▼▼▼
      AFRAME.registerComponent('auto-slideshow', {
        schema: { srcs: { type: 'array' }, interval: { type: 'number', default: 3000 } },
        init: function () {
          this.el.setAttribute('src', this.data.srcs[0]);
          this.el.setAttribute('material', 'transparent: true; opacity: 1');
          this.index = 0; this.timer = null;
        },
        play: function() {
          if (this.timer) return;
          this.timer = setInterval(() => { this.nextSlide(); }, this.data.interval);
        },
        pause: function() {
          if (this.timer) clearInterval(this.timer);
          this.timer = null;
          this.el.setAttribute('material', 'opacity', 1);
        },
        nextSlide: function () {
          const el = this.el;
          el.setAttribute('animation', { property: 'material.opacity', from: 1, to: 0, dur: 800, easing: 'easeInOutQuad' });
          setTimeout(() => {
            this.index = (this.index + 1) % this.data.srcs.length;
            el.setAttribute('src', this.data.srcs[this.index]);
            const img = document.querySelector(this.data.srcs[this.index]);
            if(img && img.naturalWidth) {
                const ratio = img.naturalHeight / img.naturalWidth;
                el.setAttribute('height', ratio);
            }
            el.removeAttribute('animation');
            el.setAttribute('animation', { property: 'material.opacity', from: 0, to: 1, dur: 800, easing: 'easeInOutQuad' });
          }, 800);
        }
      });
    </script>

    <style>
      body { margin: 0; overflow: hidden; font-family: "Yu Mincho", serif; background: #000; }
      
      /* ローディング */
      #loading { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: radial-gradient(circle, #2a2a2a 0%, #000 100%); 
        z-index: 99999; display: flex; flex-direction: column; 
        justify-content: center; align-items: center; transition: opacity 0.8s ease-out; 
      }
      .loader { 
        width: 40px; height: 40px; 
        border: 1px solid rgba(255, 255, 255, 0.1); 
        border-top: 1px solid #fff; border-radius: 50%; 
        animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite; 
      }
      #loading-text { 
        margin-top: 25px; color: #fff; font-size: 11px; 
        letter-spacing: 4px; text-transform: uppercase; font-weight: 300; opacity: 0.8;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* スキャンガイド */
      #scan-guide { 
        position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
        color: rgba(255,255,255,0.9); font-size: 13px; letter-spacing: 2px; 
        background: rgba(0,0,0,0.4); padding: 10px 20px; border-radius: 30px;
        backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);
        pointer-events: none; z-index: 8000; transition: opacity 0.5s ease;
      }

      /* フッター */
      #footer-frame { 
        position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; 
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); 
        display: flex; justify-content: center; align-items: center; 
        z-index: 9999; cursor: pointer; transition: opacity 0.3s;
      }
      .footer-text { 
        color: #fff; font-size: 11px; letter-spacing: 2px; 
        border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 3px; 
        opacity: 0.8;
      }
    </style>
  </head>
  <body>

    <div id="loading"><div class="loader"></div><div id="loading-text">LOADING EXPERIENCE</div></div>
    <div id="scan-guide">建物を映してください</div>
    <div id="footer-frame"><div class="footer-text">Tap to Open Website</div></div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets4.mind; uiError:yes; uiLoading:no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false"
      gesture-detector>
      
      <a-assets>
        <video id="vid-asset" src="./fl.mp4" preload="auto" loop="true" crossorigin="anonymous" playsinline webkit-playsinline muted></video>
        <a-asset-item id="model-asset" src="./model2.glb"></a-asset-item>
        
        <img id="slide1-2" src="./pers_1_sub1.png" /><img id="slide1-3" src="./pers_1_sub2.png" />
        <img id="slide1-4" src="./pers_1_sub3.png" /><img id="slide1-5" src="./pers_1_sub4.png" /><img id="slide1-6" src="./pers_1_sub5.png" />
        <img id="slide1-7" src="./pers_1_sub6.png" /><img id="slide1-8" src="./pers_1_sub7.png" /> 
        
        <img id="slide2-2" src="./pers_2_sub1.png" /><img id="slide2-3" src="./pers_2_sub2.png" />
        <img id="slide2-4" src="./pers_2_sub3.png" /><img id="slide2-5" src="./pers_2_sub5.png" /><img id="slide2-6" src="./pers_2_sub5.png" />
        <img id="slide2-7" src="./pers_2_sub6.png" /><img id="slide2-8" src="./pers_2_sub7.png" /><img id="slide2-9" src="./pers_2_sub8.png" />
        <img id="slide2-10" src="./pers_2_sub9.png" /><img id="slide2-11" src="./pers_2_sub10.png" /><img id="slide2-12" src="./pers_2_sub11.png" />
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false">
        <a-entity cursor="fuse: false; rayOrigin: mouse;" raycaster="objects: .clickable"></a-entity>
      </a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-entity scale="0.3 0.3 0.3">
           <a-video id="ar-video" src="#vid-asset" width="1" height="1.77"></a-video>
           
           <a-text value="MOVIE CLIP" align="center" position="0 -1.0 0" width="4" color="#fff" 
                   font="roboto" shader="msdf" negate="false"
                   text="shadowColor: #000; shadowBlur: 2; shadowOffsetX: 1; shadowOffsetY: 1;"></a-text>
        </a-entity>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 1">
        <a-entity scale="0.1 0.1 0.1">
           <a-entity id="ar-model" gltf-model="#model-asset" 
                     class="clickable"
                     gesture-handler="minScale: 0.1; maxScale: 10; rotationFactor: 5"
                     rotation="0 0 0">
           </a-entity>
           <a-text value="3D MODEL VIEW" align="center" position="0 -1.5 0" scale="2 2 2" width="4" color="#fff" 
                   font="roboto" shader="msdf" negate="false"
                   text="shadowColor: #000; shadowBlur: 2; shadowOffsetX: 1; shadowOffsetY: 1;"></a-text>
        </a-entity>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 2">
        <a-entity scale="0.7 0.7 0.7">
            <a-plane color="#000" opacity="0.3" width="1.05" height="0.8" position="0.02 -0.02 -0.01"></a-plane>
            
            <a-image id="slideshow-1" position="0 0 0" width="1" height="0.75" 
                     auto-slideshow="srcs: #slide1-2, #slide1-3, #slide1-4, #slide1-5, #slide1-6, #slide1-7, #slide1-8; interval: 3000">
            </a-image>
            
            <a-text value="BUILDING A" align="center" position="0 -0.55 0" width="4" color="#fff" 
                    font="roboto" letter-spacing="2" shader="msdf" negate="false"
                    text="shadowColor: #000; shadowBlur: 3; shadowOffsetX: 1; shadowOffsetY: 1;"></a-text>
        </a-entity>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 3">
        <a-entity scale="0.7 0.7 0.7">
            <a-plane color="#000" opacity="0.3" width="1.05" height="0.8" position="0.02 -0.02 -0.01"></a-plane>

            <a-image id="slideshow-2" position="0 0 0" width="1" height="0.75" 
                     auto-slideshow="srcs: #slide2-2, #slide2-3, #slide2-4, #slide2-5, #slide2-6, #slide2-7, #slide2-8, #slide2-9, #slide2-10, #slide2-11, #slide2-12; interval: 3000">
            </a-image>
            
            <a-text value="BUILDING B" align="center" position="0 -0.55 0" width="4" color="#fff" 
                    font="roboto" letter-spacing="2" shader="msdf" negate="false"
                    text="shadowColor: #000; shadowBlur: 3; shadowOffsetX: 1; shadowOffsetY: 1;"></a-text>
        </a-entity>
      </a-entity>

    </a-scene>

    <script>
      const loadingDiv = document.getElementById('loading');
      const scanGuide = document.getElementById('scan-guide');
      const footerFrame = document.getElementById('footer-frame');
      const sceneEl = document.querySelector('a-scene');
      
      const videoEl = document.getElementById('vid-asset');
      const slide1 = document.getElementById('slideshow-1');
      const slide2 = document.getElementById('slideshow-2');
      const arModel = document.getElementById('ar-model');

      sceneEl.addEventListener('arReady', () => { hideLoading(); });
      sceneEl.addEventListener('arError', () => { hideLoading(); alert("カメラエラー"); });
      setTimeout(() => { hideLoading(); }, 10000);

      function hideLoading() {
        if(loadingDiv.style.display !== 'none') {
            loadingDiv.style.opacity = 0;
            setTimeout(() => { loadingDiv.style.display = 'none'; }, 800);
        }
      }

      let activeTargets = 0;
      function updateGuideVisibility() {
          scanGuide.style.opacity = activeTargets > 0 ? 0 : 1;
      }

      const targets = [
          { el: document.querySelector('[mindar-image-target="targetIndex: 0"]'), type: 'video', content: videoEl },
          { el: document.querySelector('[mindar-image-target="targetIndex: 1"]'), type: 'model', content: arModel },
          { el: document.querySelector('[mindar-image-target="targetIndex: 2"]'), type: 'slide', content: slide1 },
          { el: document.querySelector('[mindar-image-target="targetIndex: 3"]'), type: 'slide', content: slide2 }
      ];

      targets.forEach(t => {
          if(!t.el) return;
          t.el.addEventListener('targetFound', () => {
              activeTargets++;
              updateGuideVisibility();
              if (t.type === 'video') t.content.play();
              if (t.type === 'slide' && t.content.components['auto-slideshow']) t.content.components['auto-slideshow'].play();
              if (t.type === 'model') sceneEl.emit('markerFound');
          });
          
          t.el.addEventListener('targetLost', () => {
              activeTargets--;
              if(activeTargets < 0) activeTargets = 0;
              updateGuideVisibility();
              if (t.type === 'video') t.content.pause();
              if (t.type === 'slide' && t.content.components['auto-slideshow']) t.content.components['auto-slideshow'].pause();
              if (t.type === 'model') sceneEl.emit('markerLost');
          });
      });

      footerFrame.addEventListener('click', () => {
        window.open('https://lykke-hygge-2.myshopify.com/', '_blank'); 
      });
    </script>
  </body>
</html>
