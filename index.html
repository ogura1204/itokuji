<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>町家の日 GPS AR (Geospatial Like)</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: "Yu Mincho", serif; }
      
      /* 上部ステータス */
      #status-bar {
        position: fixed; top: 0; left: 0; width: 100%;
        background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        color: white; padding: 10px; text-align: center;
        z-index: 9999; pointer-events: none;
        text-shadow: 1px 1px 2px black;
      }

      /* 補正コントローラー */
      #controls {
        position: fixed; bottom: 12%; left: 0; width: 100%;
        display: flex; flex-direction: column; align-items: center; gap: 5px;
        z-index: 9999; pointer-events: auto;
      }
      .row { display: flex; gap: 10px; }
      
      button {
        background: rgba(255, 255, 255, 0.2); 
        color: white; border: 1px solid white;
        width: 50px; height: 40px; border-radius: 5px;
        font-weight: bold; backdrop-filter: blur(5px);
      }
      button:active { background: rgba(255, 255, 255, 0.5); }
      
      .label-btn { width: auto; padding: 0 10px; font-size: 12px; border: none; background: none; }

      #footer-frame { position: fixed; bottom: 0; left: 0; width: 100%; height: 10%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; }
      .f-text { color: white; font-size: 12px; pointer-events: auto; cursor: pointer; padding: 10px; }
    </style>
  </head>
  
  <body>
    <div id="status-bar">
        GPS 取得中...<br>
        <span id="dist-label" style="font-size: 1.2em; color: yellow;">--- m</span>
    </div>

    <div id="controls">
        <button class="label-btn">位置調整</button>
        <div class="row">
            <button onclick="moveModel('z', -1)">奥</button>
        </div>
        <div class="row">
            <button onclick="moveModel('x', -1)">左</button>
            <button onclick="moveModel('y', -1)">下</button>
            <button onclick="moveModel('y', 1)">上</button>
            <button onclick="moveModel('x', 1)">右</button>
        </div>
        <div class="row">
            <button onclick="moveModel('z', 1)">手前</button>
        </div>
        <div class="row" style="margin-top: 10px;">
             <button onclick="scaleModel(0.9)" style="width:auto; padding:0 10px;">縮小</button>
             <button onclick="scaleModel(1.1)" style="width:auto; padding:0 10px;">拡大</button>
        </div>
    </div>

    <div id="footer-frame"><div class="f-text" onclick="window.open('https://lykke-hygge-2.myshopify.com/', '_blank');">Tap to Open Shop</div></div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false;'
      renderer="colorManagement: true; physicallyCorrectLights: true; toneMapping: ACESFilmic; exposure: 1.0;">

      <a-assets>
        <a-asset-item id="model-glb" src="./model2.glb"></a-asset-item>
      </a-assets>

      <a-camera gps-new-camera='gpsMinDistance: 0; maxDistance: 1000;' near="0.1" far="10000" rotation-reader></a-camera>

      <a-light type="ambient" color="#ffffff" intensity="1.5"></a-light>
      <a-light type="directional" color="#ffffff" intensity="2.0" position="0 10 0"></a-light>

      <a-entity gps-new-entity-place="latitude: 34.82749460261197; longitude: 134.68015716788724;">
        
        <a-entity id="manual-adjust-wrapper" position="0 0 0">
            
            <a-entity look-at="[gps-new-camera]">

                <a-entity position="0 9 0" scale="2 2 2">
                    <a-plane color="black" opacity="0.6" width="2" height="0.8"></a-plane>
                    <a-plane color="#C5A059" width="1.8" height="0.02" position="0 -0.2 0.01"></a-plane>
                    <a-text value="2026.8 OPEN" align="center" width="6" position="0 0.1 0.1"></a-text>
                    <a-text value="GRAND OPEN" align="center" color="#C5A059" width="4" position="0 -0.1 0.1"></a-text>
                </a-entity>

                <a-entity id="my-model"
                          gltf-model="#model-glb" 
                          position="0 0 0" 
                          scale="5 5 5">
                </a-entity>
                
            </a-entity>

        </a-entity>
      </a-entity>

    </a-scene>

    <script>
      // ビルボード処理（常に自分の方を向く）
      AFRAME.registerComponent('look-at', {
        schema: { type: 'selector' },
        init: function () {},
        tick: function () {
          this.el.object3D.lookAt(this.el.sceneEl.camera.position);
        }
      });

      const adjustWrapper = document.getElementById('manual-adjust-wrapper');
      const model = document.getElementById('my-model');
      const distLabel = document.getElementById('dist-label');
      const statusBar = document.getElementById('status-bar');

      // 距離表示の更新
      window.addEventListener('gps-camera-update-position', function(e) {
          // カメラとターゲットの距離を計算
          const camera = document.querySelector('[gps-new-camera]');
          const target = document.querySelector('[gps-new-entity-place]');
          
          if(camera && target) {
             const dist = camera.components['gps-new-camera'].threeCamera.position.distanceTo(target.object3D.position);
             // AR.jsの座標系スケールに合わせた概算距離
             // ※gps-new-cameraは座標系が独特なため、あくまで目安表示
             distLabel.innerText = "GPS Active (近くを探してください)";
             statusBar.style.color = "lime";
          }
      });

      // 手動位置補正
      function moveModel(axis, val) {
          const currentPos = adjustWrapper.getAttribute('position');
          // 移動量を大きくする（屋外スケールのため 2m 単位）
          const step = 2.0;
